<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login</title>
    <link href="favicon.ico" rel="icon" type="image/x-icon">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <!--    <link type="text/css" rel="stylesheet" href="css/style.css" />-->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap"
          rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script charset="UTF-8" src="/js/webauthn-debug.js" type="text/javascript"></script>
    <style>


        .code {
            white-space: pre;
        }
    </style>
</head>

<body>
<div class="container">
    <input id="userName" placeholder="User name"/><br/>
    <button id="login">Login</button>
    <button id="register">Register</button>
</div>

<div id="trace"></div>

<div class="container step" id="server1">
    The interaction starts with an AJAX call.
    <div class="code">POST <span id="server1-url"></span>
        <div id="server1-call"></div>
    </div>
    The server prepares a challenge for the browser to sign.
    <div class="code" id="server1-response"></div>
</div>

<div class="container step" id="navigator">
    The challenge is passed to the browser call:
    <div class="code" id="navigator-call">navigator.credentials.create(...);</div>
    Which responds:
    <div class="code" id="navigator-response"></div>
    The <strong>response.clientDataJSON</strong> are base64 encoded:
    <div class="code" id="navigator-clientDataJSON"></div>
</div>

<div class="container step" id="server2">

    <div class="code" id="server2-call"></div>
</div>
</div>

<div id="result"></div>

<form action="#" method="POST">
    <input name="sessionId" type="hidden" value="somesessionid">
    <div id="form-generated"></div>
    <button type="submit">Finish</button>
</form>

<script type="text/javascript">
    function tryDecodeBase64(str) {
        try {
            return atob(str);
        } catch (e) {
            return e + "";
        }
    }

    function fillOrHideFormField(id, value) {
        let el = document.getElementById(id);
        if (!el) throw "No element #" + id;
        el.value = value;
        if (value !== undefined) {
            el.style.display = "";
        } else {
            //el.style.display = "none";
        }
    }

    function fillOrHideJsonField(id, value) {
        $("#" + id).remove();
        $
        let el = document.getElementById(id);
        if (!el) throw "No element #" + id;
        if (value !== undefined) {
            el.style.display = "";
            el.innerHTML = tryDecodeBase64(value);
        } else {
            el.style.display = "none";
        }
    }

    function tracer(stage, params) {
        console.log(stage, params)

        switch (stage) {
            case "register-request":
                return traceRegisterRequest(params);
            case "register-response":
                return traceRegisterResponse(params);
            case "credentials-create-request":
                return traceCredentialsCreateRequest(params);
            case "credentials-create-response":
                return traceCredentialsCreateResponse(params);
            case "login-request":
                return traceLoginRequest(params);
            case "login-response":
                return traceLoginResponse(params);
            case "credentials-get-request":
                return traceCredentialsGetRequest(params);
            case "credentials-get-response":
                return traceCredentialsGetResponse(params);
            default:
                return traceGeneric(stage, params);
        }
    }

    function continueButton(where, result) {
        const button = $("<button>Continue</button>").appendTo(where)
        return new Promise((resolve, reject) => {
            button.click(() => {
                resolve(result);
                $(button).remove();
            });
        });
    }

    function traceRegisterRequest(params) {
        $(".step").hide();
        $("#server1").show();
        $("#server1-url").html(params.url)
        $("#server1-call").html(JSON.stringify(params.body, null, 2));
        return continueButton("#server1-call", params);
    }

    function traceRegisterResponse(params) {
        $("#server1-response").html(JSON.stringify(params, null, 2));
        return continueButton("#server1-response", params);
    }

    function traceLoginRequest(params) {
        $(".step").hide();
        $("#server1").show();
        $("#server1-url").html(params.url)
        $("#server1-call").html(JSON.stringify(params.body, null, 2));
        return continueButton("#server1-call", params);
    }

    function traceLoginResponse(params) {
        $("#server1-response").html(JSON.stringify(params, null, 2));
        return continueButton("#server1-response", params);
    }

    function traceCredentialsCreateRequest(challenge) {
        $("#navigator").show();
        //$("#navigator-call").html(JSON.stringify(challenge, null, 2));
        return continueButton("#navigator-call", challenge);
    }

    function traceCredentialsCreateResponse(response) {
        $("#navigator-response").html(JSON.stringify(response, null, 2));
        $("#navigator-clientDataJSON").html(JSON.stringify(JSON.parse(tryDecodeBase64(response.response.clientDataJSON)), null, 2));
        return continueButton("#navigator-response", response);
    }

    function traceCredentialsGetRequest(challenge) {
        $("#navigator").show();
        //$("#navigator-call").html(JSON.stringify(challenge, null, 2));
        return continueButton("#navigator-call", challenge);
    }

    function traceCredentialsGetResponse(response) {
        $("#navigator-response").html(JSON.stringify(response, null, 2));
        $("#navigator-clientDataJSON").html(JSON.stringify(JSON.parse(tryDecodeBase64(response.response.clientDataJSON)), null, 2));
        return continueButton("#navigator-response", response);
    }

    function traceGeneric(stage, params) {
        const content = JSON.stringify(params);
        const trace = $("<div class='container'></div>").attr("id", stage).html(content).appendTo("#trace");
        const button = $("<button>Continue</button>").appendTo(trace)
        return new Promise((resolve, reject) => {
            button.click(() => {
                resolve(params);
                $(button).remove();
            });
        });
    }

    function form(action, fields) {
        const $form = $("form").attr("action", action);
        const $fields = $("#form-generated", $form).empty()
        for ([key, value] of Object.entries(fields)) {
            console.log(key);
            $("<input type='hidden'>").attr("name", key).val(value).appendTo($fields)
        }
    }

    const webAuthn = new WebAuthn({
        callbackPath: '/q/webauthn/callback',
        registerPath: '/q/webauthn/register',
        loginPath: '/q/webauthn/login',
        // loginCallbackPath: '/webauthn/login',
        // registerCallbackPath: '/webauthn/register',
        debuggingFunction: tracer
    });

    const result = document.getElementById('result');

    const loginButton = document.getElementById('login');

    loginButton.onclick = () => {
        var userName = document.getElementById('userName').value;
        result.replaceChildren();
        webAuthn.loginOnly({name: userName})
            .then(body => {
                form("/webauthn/login", {
                    'webAuthnId': body.id,
                    'webAuthnRawId': body.rawId,
                    'webAuthnResponseClientDataJSON': body.response.clientDataJSON,
                    'webAuthnResponseAuthenticatorData': body.response.authenticatorData,
                    'webAuthnResponseSignature': body.response.signature,
                    'webAuthnResponseUserHandle': body.response.userHandle,
                    'webAuthnType': body.type
                });
            })
            .catch(err => {
                result.append("Login failed: " + err);
                console.error(err);
            });
        return false;
    };

    const registerButton = document.getElementById('register');

    registerButton.onclick = () => {
        var userName = document.getElementById('userName').value;
        // var firstName = document.getElementById('firstName').value;
        // var lastName = document.getElementById('lastName').value;
        result.replaceChildren();


        webAuthn.registerOnly({name: userName, displayName: userName /*firstName + " " + lastName*/})
            .then(body => {
                form("/webauthn/register", {
                    'webAuthnId': body.id,
                    'webAuthnRawId': body.rawId,
                    'webAuthnResponseAttestationObject': body.response.attestationObject,
                    'webAuthnResponseClientDataJSON': body.response.clientDataJSON,
                    'webAuthnType': body.type
                });
            })
            .catch(err => {
                result.append("Registration failed: " + err);
                console.error(err);
            });
        return false;
    };
</script>
</body>
</html>