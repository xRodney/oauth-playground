<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login</title>
    <link href="favicon.ico" rel="icon" type="image/x-icon">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <!--    <link type="text/css" rel="stylesheet" href="css/style.css" />-->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap"
          rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script charset="UTF-8" src="/js/webauthn-debug.js" type="text/javascript"></script>
    <style>
        .container {
            display: grid;
            grid-template-columns: auto auto auto;
        }

        button, input {
            margin: 5px 0;
        }

        .item {
            padding: 20px;
        }

        nav > ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #333;
        }

        nav > ul > li {
            float: left;
        }

        nav > ul > li > a {
            display: block;
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
        }

        nav > ul > li > a:hover {
            background-color: #111;
        }
    </style>
</head>

<body>
<div class="container">
    <input id="userName" placeholder="User name"/><br/>
    <button id="login">Login</button>
    <button id="register">Register</button>
</div>

<div id="trace"></div>

<div class="container" id="server1">
    <div id="server1-call"></div>
    <div id="server1-response"></div>
</div>

<div class="container" id="navigator">
    <div id="navigator-call"></div>
    <div id="navigator-response"></div>
</div>

<div class="container" id="server2">
    <div id="server2-call"></div>
    <div id="server2-response"></div>
</div>
</div>

<div id="result"></div>

<form action="#" method="POST">
    <input id="webAuthnId" name="webAuthnId" placeholder="webAuthnId"/><br/>
    <input id="webAuthnRawId" name="webAuthnRawId" placeholder="webAuthnRawId"/><br/>
    <input id="webAuthnResponseAttestationObject" name="webAuthnResponseAttestationObject"
           placeholder="webAuthnResponseAttestationObject"/><br/>
    <input id="webAuthnResponseClientDataJSON" name="webAuthnResponseClientDataJSON"
           placeholder="webAuthnResponseClientDataJSON"/><br/>
    <div id="webAuthnResponseClientDataJSONJson"></div>
    <br/>
    <input id="webAuthnResponseAuthenticatorData" name="webAuthnResponseAuthenticatorData"
           placeholder="webAuthnResponseAuthenticatorData"/><br/>
    <div id="webAuthnResponseAuthenticatorDataJson"></div>
    <br/>
    <input id="webAuthnResponseSignature" name="webAuthnResponseSignature"
           placeholder="webAuthnResponseSignature"/><br/>
    <div id="webAuthnResponseSignatureJson"></div>
    <br/>
    <input id="webAuthnResponseUserHandle" name="webAuthnResponseUserHandle"
           placeholder="webAuthnResponseUserHandle"/><br/>
    <div id="webAuthnResponseUserHandleJson"></div>
    <br/>

    <input id="webAuthnType" name="webAuthnType" placeholder="webAuthnType"/><br/>
    <button formaction="/webauthn/register" type="submit">Finish registration</button>
    <button formaction="/webauthn/login" type="submit">Finish login</button>
</form>

<script type="text/javascript">
    function tryDecodeBase64(str) {
        try {
            return atob(str);
        } catch (e) {
            return e + "";
        }
    }

    function fillOrHideFormField(id, value) {
        let el = document.getElementById(id);
        if (!el) throw "No element #" + id;
        el.value = value;
        if (value !== undefined) {
            el.style.display = "";
        } else {
            //el.style.display = "none";
        }
    }

    function fillOrHideJsonField(id, value) {
        let el = document.getElementById(id);
        if (!el) throw "No element #" + id;
        if (value !== undefined) {
            el.style.display = "";
            el.innerHTML = tryDecodeBase64(value);
        } else {
            el.style.display = "none";
        }
    }

    function tracer(stage, params) {
        console.log(stage, params)
        const content = JSON.stringify(params);
        const trace = $("<div class='container'></div>").attr("id", stage).html(content).appendTo("#trace");
        const button = $("<button>Continue</button>").appendTo(trace)
        return new Promise((resolve, reject) => {
            button.click(() => {
                resolve(params);
                $(button).remove();
            });
        });
    }

    const webAuthn = new WebAuthn({
        callbackPath: '/q/webauthn/callback',
        registerPath: '/q/webauthn/register',
        loginPath: '/q/webauthn/login',
        // loginCallbackPath: '/webauthn/login',
        // registerCallbackPath: '/webauthn/register',
        debuggingFunction: tracer
    });

    const result = document.getElementById('result');

    const loginButton = document.getElementById('login');

    loginButton.onclick = () => {
        var userName = document.getElementById('userName').value;
        result.replaceChildren();
        webAuthn.loginOnly({name: userName})
            .then(body => {
                // store the registration JSON in form elements
                fillOrHideFormField('webAuthnId', body.id);
                fillOrHideFormField('webAuthnRawId', body.rawId);
                fillOrHideFormField('webAuthnResponseClientDataJSON', body.response.clientDataJSON);
                fillOrHideJsonField('webAuthnResponseClientDataJSONJson', body.response.clientDataJSON);
                fillOrHideFormField('webAuthnResponseAuthenticatorData', body.response.authenticatorData);
                fillOrHideFormField('webAuthnResponseSignature', body.response.signature);
                fillOrHideFormField('webAuthnResponseUserHandle', body.response.userHandle);
                fillOrHideFormField('webAuthnType', body.type);


                // document.getElementById('webAuthnId').value = body.id;
                // document.getElementById('webAuthnRawId').value = body.rawId;
                // document.getElementById('webAuthnResponseClientDataJSON').value = body.response.clientDataJSON;
                // document.getElementById('webAuthnResponseAuthenticatorData').value = body.response.authenticatorData;
                // document.getElementById('webAuthnResponseSignature').value = body.response.signature;
                // document.getElementById('webAuthnResponseUserHandle').value = body.response.userHandle;
                // document.getElementById('webAuthnType').value = body.type;
            })
            .catch(err => {
                result.append("Login failed: " + err);
                console.error(err);
            });
        return false;
    };

    const registerButton = document.getElementById('register');

    registerButton.onclick = () => {
        var userName = document.getElementById('userName').value;
        // var firstName = document.getElementById('firstName').value;
        // var lastName = document.getElementById('lastName').value;
        result.replaceChildren();


        webAuthn.registerOnly({name: userName, displayName: userName /*firstName + " " + lastName*/})
            .then(body => {
                // store the registration JSON in form elements
                fillOrHideFormField('webAuthnId', body.id);
                fillOrHideFormField('webAuthnRawId', body.rawId);
                fillOrHideFormField('webAuthnResponseAttestationObject', body.response.attestationObject);
                fillOrHideFormField('webAuthnResponseClientDataJSON', body.response.clientDataJSON);
                fillOrHideJsonField('webAuthnResponseClientDataJSONJson', body.response.clientDataJSON);
                fillOrHideFormField('webAuthnType', body.type);

            })
            .catch(err => {
                result.append("Registration failed: " + err);
                console.error(err);
            });
        return false;
    };
</script>
</body>
</html>